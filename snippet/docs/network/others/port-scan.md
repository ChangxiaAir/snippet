
端口扫描
======

## 1、TCP扫描

### (1) 原理
尝试与目标主机的某些端口建立连接（一般使用网络套接字`socket`），如果目标主机该端口有回复（三次握手中的第二次），则说明该端口开放，即为“`活动端口`”。

#### 三次握手过程：
    a. 首先客户端（请求方）在连接请求中，向服务器端（接收方）发送SYN＝1，ACK＝0的TCP数据包，表示希望与服务器建立一个连接
    b. 如果服务器响应这个连接请求，就返回一个SYN＝1，ACK＝1的数据包给客户端，表示服务器同意建立这个连接，并要求客户端进行确认
    c. 最后客户端发送一个SYN＝0，ACK＝1的数据包给服务器端，表示确认建立连接。

### (2) 分类
#### A. 全TCP连接
这种扫描方法使用三次握手与目标计算机建立标准的TCP连接，即与目标主机建立完整的TCP连接。如果连接成功，则表示被测端口是开放的；否则被测端口是关闭的。需要说明的是，**`这种古老的扫描方法很容易被目标主机记录`**。

#### B. 半打开式扫描（SYN扫描）
在这种扫描技术中，扫描主机自动向目标计算的指定端口发送SYN数据段，表示发送建立连接请求。

    A. 如果目标计算机的回应TCP报文中SYN＝1，ACK＝1，则说明该端口是活动的，
       接着扫描主机传送一个RST给目标主机拒绝建立TCP连接，从而导致三次握手过程失败。
    B. 如果目标计算机的回应是RST，则表示该端口为“死端口”；在这种情况下，扫描主机不用做任何回应。

_由于在扫描过程中，全连接尚未建立，所以大降低了被目标计算机的记录的可能，并且加快了扫描的速度。由于其扫描行为较为明显，所以SYN 扫描容易被入侵检测系统发现，也容易被防火墙屏蔽；同时构造原始的TCP 数据包也需要较高的系统权限（在 Linux 中仅限于 root 账号）。_

#### C. FIN扫描
在TCP报文中，有一个字段为FIN，FIN扫描则依靠发送FIN来判断目标计算的指定端口是否活动。

##### 原理
发送一个FIN＝1的TCP报文到一个关闭的端口时，该报文会被丢弃，并返回一个RST报文。但是，如果当FIN报文到一个活动的端口时，该报文只是简单的丢掉，不会返回任何回应。注：必须能够确认目标主机存在。

_**从 FIN 扫描可以看出，这种扫描没有涉及任何TCP 连接部分，因此，这种扫描比前两种都安全，可以称之为秘密扫描。但是，由于不同系统实现网络协议栈的细节不同，FIN 扫描只能扫描Linux/Unix系统。对于Windows系统而言，由于无论其端口开放与否，都会返回 RST 数据包，因此对端口的状态无法进行判断。**_

#### D. ACK扫描
发送一个只有ACK标志的TCP数据包给主机，如果主机反馈一个`TCP RST`数据包，则这个主机是存在的。

**也可以通过这种技术来确定对方防火墙仅仅是简单的分组过滤，还是基于状态的防火墙。**

#### E. NULL扫描
发送一个没有任何标志位的TCP数据包，根据`RFC793`，如果目标主机的相应端口是关闭的，则应该返回一个`RST`数据包。

#### F. FIN＋URG＋PUSH扫描
向目标主机发送一个`FIN`、`URG`和`PUSH`分组，根据`RFC793`，如果目标主机的相应端口是关闭的，则应该返回一个`RST`数据包。


## 2、UDP扫描
一般情况下，当向一个关闭的UDP端口发送数据包时，目标主机会返回一个`ICMP不可达（ICMP port unreachable）`的错误。UDP扫描就是利用了上述原理，向被扫描端口发送0字节的UDP数据包，如果收到一个`ICMP不可达响应`，则认为端口是关闭的；而对于那些长时间没有响应的端口，则认为是开放的。

_因为大部分系统都限制了ICMP差错报文的产生速度，所以针对特定主机的大范围UDP端口扫描的速度非常缓慢。此外，UDP协议和ICMP协议是不可靠协议，数据包丢失也可能造成没有收到响应的情况，因此扫描程序必须对同一端口进行多次尝试后才能得出正确的结论。_

### ICMP扫描扩展
根据`TCP/IP`协议，如果在通信过程中出现错误，则接收端将产生一个`ICMP`的错误报文，用来通告发送端错误的相关信息。这些错误报文是根据`ICMP`协议要求由探测系统自动产生的，一般不会被防火墙拦截。这也是黑客常用的手段。

#### A. ICMP扩展扫描中的4种实现方式：
    (1) 向目标主机发送一个只有IP头的数据报，目标主机将返回Destination Unreachable的ICMP错误报文。
    (2) 向目标主机发送一个错误的IP数据报，比如，IP头长度错误。目标主机将返回Parameter Problem的ICMP错误报文。
    (3) 当数据报分片，但是却没有给接收端足够的分片时，接收端分片组装超时会发送分片组装超时的ICMP错误报文。
    (4) 向目标主机发送一个IP数据报，但是协议项是错误的，比如协议项不可用，则目标将返回Destination Unreachable的
        ICMP错误报文。

#### B. ICMP扩展扫描的另外两种功能：
    (1) 探测防火墙的存在
        将数据包的IP头协议字段填入一个至今无人使用的较大的值，向确定存在的主机发送该数据包，
        若收不到响应，则说明目标主机有防火墙保护。
    (2) 探测目标主机运行的协议
        因为IP头协议字段的长度为8位，所以只有256种协议的可能。
        遍历256种可能的协议，探测目标主机，但可穷举目标主机当前运行的协议。


## 3、第三方扫描
第三方扫描又称“`代理扫描`”，这种扫描是利用第三方主机来代替入侵者进行扫描。这个第三个方主机一般是入侵者通过入侵其他计算机而得到的，该“第三方”主机常被入侵者称之为“肉鸡”。这些“肉鸡”一般为安全防御系数极低的个人计算机。
